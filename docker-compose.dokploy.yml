version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    environment:
      - NODE_ENV=production
      - VITE_API_URL=https://api.${DOMAIN}
      - VITE_WS_URL=wss://ws.${DOMAIN}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.virtualhems-frontend.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.virtualhems-frontend.entrypoints=websecure"
      - "traefik.http.services.virtualhems-frontend.loadbalancer.server.port=80"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.virtualhems-frontend-http.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-frontend-http.entrypoints=web"
      - "traefik.http.routers.virtualhems-frontend-http.middlewares=redirect-to-https"
    restart: unless-stopped
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=production
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - S3_BUCKET=${S3_BUCKET}
      - REDIS_URL=redis://redis:6379
      - WORKERS=4
      - MAX_CONNECTIONS=1000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.virtualhems-backend.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.virtualhems-backend.entrypoints=websecure"
      - "traefik.http.services.virtualhems-backend.loadbalancer.server.port=8001"
      - "traefik.http.routers.virtualhems-backend-http.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-backend-http.entrypoints=web"
      - "traefik.http.routers.virtualhems-backend-http.middlewares=redirect-to-https"
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  websocket:
    build:
      context: ./backend
      dockerfile: Dockerfile.websocket
    environment:
      - NODE_ENV=production
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.virtualhems-websocket.rule=Host(`ws.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-websocket.tls.certresolver=letsencrypt"
      - "traefik.http.routers.virtualhems-websocket.entrypoints=websecure"
      - "traefik.http.services.virtualhems-websocket.loadbalancer.server.port=8787"
      - "traefik.http.routers.virtualhems-websocket-http.rule=Host(`ws.${DOMAIN}`)"
      - "traefik.http.routers.virtualhems-websocket-http.entrypoints=web"
      - "traefik.http.routers.virtualhems-websocket-http.middlewares=redirect-to-https"
    restart: unless-stopped
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 8787)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Optional: Redis Commander for database management
  redis-commander:
    image: rediscommander/redis-commander:latest
    environment:
      - REDIS_HOSTS=local:redis:6379
      - HTTP_USER=${REDIS_COMMANDER_USER:-admin}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD:-admin123}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redis-commander.rule=Host(`redis.${DOMAIN}`)"
      - "traefik.http.routers.redis-commander.tls.certresolver=letsencrypt"
      - "traefik.http.routers.redis-commander.entrypoints=websecure"
      - "traefik.http.services.redis-commander.loadbalancer.server.port=8081"
      - "traefik.http.routers.redis-commander.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${REDIS_COMMANDER_USER:-admin}:${REDIS_COMMANDER_PASSWORD_HASH}"
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

volumes:
  redis_data:
    driver: local